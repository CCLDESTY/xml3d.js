<?xml version="1.0" encoding="UTF-8"?>
<!-- ======================================================================
     project    xml3d.js
     description
     Deploy script that prepares a single xml3d.js script file

     Author: Kristian Sons
     ====================================================================== -->
<project name="script-merge" default="develop">
	<description>
           Merge all the single scripts to one global xml3d.js
    </description>

	<property file="build.properties" />

	<macrodef name="git">
		<attribute name="command" />
		<attribute name="git" default="${git.cmd}" />
		<attribute name="dir" default="" />
		<element name="args" optional="true" />
		<sequential>
			<echo message="@{git} @{command}" />
			<exec executable="@{git}" dir="@{dir}" outputproperty="git.output">
				<arg value="@{command}" />
				<args />
			</exec>
		</sequential>
	</macrodef>

	<macrodef name="post-file" description="Use Curl to post the file to the WEBDAV path">
	    <attribute name="file"/>
	    <attribute name="url" />
	    <sequential>
	        <echo message="Using CURL to upload @{file} to @{url}" />
	        <!--Execute curl to post the file to the URL -->
	        <exec executable="${curl.path}">
                <arg value="-n" />
	        	<arg value="-s" />
	            <arg value="-T" />
                <arg value='@{file}' />
	            <arg value='@{url}'/>
	        </exec>
	    </sequential>
	</macrodef>

	<target name="checkOS">
		<condition property="isWindows">
			<os family="windows" />
		</condition>
		<condition property="isLinux">
			<os family="unix" />
		</condition>
	</target>

	<target name="windowsGit" depends="checkOS" if="isWindows">
		<property name="git.cmd" value="git.cmd" />
	</target>
	<target name="linuxGit" depends="checkOS" if="isLinux">
		<property name="git.cmd" value="git" />
	</target>

	<target name="stable">
		<property name="versionStr" value="v${version}" />
		<property name="script.ext" value="-${version}" />
		<antcall target="concat" />
	</target>

   <target name="lastTag" depends="windowsGit, linuxGit">
        <tstamp />
        <git command="describe">
            <args>
                <arg value="--tags" />
                <arg value="--abbrev=0" />
            </args>
        </git>
        <echo message="${git.output}" />
        <property name="versionStr" value="${git.output}" />
        <property name="script.ext" value="-${git.output}" />
        <antcall target="build" />
        <antcall target="upload" />
    </target>

   <target name="continuous" depends="windowsGit, linuxGit">
        <tstamp />
        <git command="log">
            <args>
                <arg value="-1" />
                <arg value="--format=%h / %ci" />
            </args>
        </git>
        <echo message="${git.output}" />
        <property name="versionStr" value="DEVELOPMENT / ${git.output}" />
        <property name="script.ext" value="-dev" />
        <antcall target="build" />
        <antcall target="upload" />
    </target>

	<target name="develop">
		<tstamp />
		<property name="versionStr" value="DEVELOPMENT SNAPSHOT (${TODAY})" />
		<property name="script.ext" value="" />
		<antcall target="build" />
	</target>

	<filelist dir="${srcDir}" id="sourceFiles">
		<file name="xml3d.js" />
		<file name="utils/misc.js" />
		<file name="utils/array.js" />
		<file name="utils/debug.js" />
		<file name="utils/color.js" />
        <file name="utils/uri.js" />
        <file name="contrib/glu.js" />
		<file name="contrib/glMatrix.js" />
		<file name="types/vec3.js" />
		<file name="types/rotation.js" />
		<file name="types/box.js" />
		<file name="types/matrix.js" />
		<file name="types/ray.js" />
		<file name="base/adapter.js" />
		<file name="interface/notification.js" />
		<file name="interface/factory.js" />
		<file name="interface/dom.js" />
		<file name="interface/elements.js" />
		<file name="interface/attributes.js" />
		<file name="interface/methods.js" />
		<file name="interface/configuration.js" />
		<file name="renderer/canvashandler.js" />
        <file name="renderer/utils.js" />
		<file name="renderer/shadermanager.js" />
		<file name="renderer/bufferhandler.js" />
		<file name="renderer/renderer.js" />
		<file name="renderer/adapter/xml3d.js" />
		<file name="renderer/adapter/transform.js" />
		<file name="renderer/adapter/view.js" />
		<file name="renderer/adapter/shader.js" />
		<file name="renderer/adapter/texture.js" />
		<file name="renderer/adapter/mesh.js" />
		<file name="renderer/adapter/group.js" />
		<file name="renderer/adapter/light.js" />
		<file name="renderer/adapter/data.js" />
		<file name="renderer/adapter/factory.js" />
		<file name="renderer/shaders.js" />
		<file name="renderer/xflow/xflow.js" />
	</filelist>

	<!-- - - - - - - - - - - - - - - - - -
          target: build
         - - - - - - - - - - - - - - - - - -->
    <target name="build" depends="clean">
    	<fail unless="script.ext"/>
        <antcall target="build-xml3d.js" />
        <antcall target="build-tools" />
    </target>

    <!-- - - - - - - - - - - - - - - - - -
          target: build
         - - - - - - - - - - - - - - - - - -->
    <target name="upload">
        <fail unless="script.ext"/>
        <antcall target="upload-xml3d.js" />
        <antcall target="upload-tools" />
    </target>

	<target name="physics" depends="clean" description="description">
		<concat destfile="${buildDir}/${physicsScriptName}">
			<fileset file="${basedir}/preamble.txt" />
			<fileset file="${physicsDir}/xml3d_physics.js" />
			<fileset file="${physicsDir}/xml3d_physics_interaction.js" />
		</concat>
		<replaceregexp file="${buildDir}/${physicsScriptName}" match="%VERSION%" replace="${version}" byline="true" />

	</target>

	<target name="clean">
		<delete dir="${buildDir}">
		</delete>
	</target>
    <!-- - - - - - - - - - - - - - - - - -
          Tools
         - - - - - - - - - - - - - - - - - -->
    <target name="build-xml3d.js" description="Merges the core xml3d.js parts">
    	   <property name="finalScript" value="${buildDir}/${script.start}${script.ext}.js" />
	       <concat destfile="${finalScript}">
	       <header>/**
</header>
           <fileset file="${basedir}/../LICENSE" />
           <footer>*/
/** @version: ${versionStr} **/
</footer>
	       </concat>

	       <concat destfile="${finalScript}" eol="unix" append="true">
	        <filelist refid="sourceFiles"/>
	       </concat>
	        <replaceregexp file="${finalScript}" match="xml3d.webgl.checkError\(" replace="//xml3d.webgl.checkError\(" byline="true" />
	        <replaceregexp file="${finalScript}" match="%VERSION%" replace="${versionStr}" byline="true" />
	    </target>


    <target name="upload-xml3d.js">
        <fail unless="upload.url"/>
        <property name="finalScript" value="${buildDir}/${script.start}${script.ext}.js" />
        <post-file file="${finalScript}" url="${upload.url}" />
    </target>

	<!-- - - - - - - - - - - - - - - - - -
          Tools
         - - - - - - - - - - - - - - - - - -->
    <target name="build-tools">
        <copy file="${srcDir}/../tools/camera.js" toFile="${buildDir}/tools/camera${script.ext}.js" />
    </target>

    <target name="upload-tools">
    	 <fail unless="upload.url"/>
    	 <post-file file="${buildDir}/tools/camera${script.ext}.js" url="${upload.url}/tools/" />
    </target>


</project>
