<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     15.07.2010 14:51:00                                                        

     project    XML3D Blender Exporter
     description
     Deploy script that prepares a single Blender Script to export XML3D files. 
                   
     Author: Kristian Sons                                                                
     ====================================================================== -->
<project name="script-merge" default="develop">
	<description>
           Merge all the single scripts to one global xml3d.js
    </description>

	<property file="build.properties" />

	<macrodef name="git">
		<attribute name="command" />
		<attribute name="git" default="${git.cmd}" />
		<attribute name="dir" default="" />
		<element name="args" optional="true" />
		<sequential>
			<echo message="@{git} @{command}" />
			<exec executable="@{git}" dir="@{dir}" outputproperty="git.output">
				<arg value="@{command}" />
				<args />
			</exec>
		</sequential>
	</macrodef>

	<target name="checkOS">
		<condition property="isWindows">
			<os family="windows" />
		</condition>
		<condition property="isLinux">
			<os family="unix" />
		</condition>
	</target>

	<target name="windowsGit" depends="checkOS" if="isWindows">
		<property name="git.cmd" value="git.cmd" />
	</target>
	<target name="linuxGit" depends="checkOS" if="isLinux">
		<property name="git.cmd" value="git" />
	</target>

	<target name="stable">
		<property name="versionStr" value="v${version}" />
		<property name="script.ext" value="-${version}" />
		<antcall target="base" />
	</target>

	<target name="nightly" depends="windowsGit, linuxGit">
		<tstamp />
		<git command="log">
			<args>
				<arg value="-1" />
				<arg value="--format=%h / %ci" />
			</args>
		</git>
		<echo message="${git.output}" />
		<property name="versionStr" value="nightly / ${git.output}" />
		<property name="script.ext" value="-nightly" />
		<antcall target="base" />
	</target>

	<target name="develop">
		<tstamp />
		<property name="versionStr" value="DEVELOPMENT SNAPSHOT (${TODAY})" />
		<property name="script.ext" value="" />
		<antcall target="base" />
	</target>

	<filelist dir="${srcDir}" id="sourceFiles">
		<file name="xml3d.js" />
		<file name="utils/misc.js" />
		<file name="utils/array.js" />
		<file name="utils/debug.js" />
		<file name="utils/color.js" />
        <file name="utils/uri.js" />
        <file name="contrib/glu.js" />
		<file name="contrib/glMatrix.js" />
		<file name="types/vec3.js" />
		<file name="types/rotation.js" />
		<file name="types/box.js" />
		<file name="types/matrix.js" />
		<file name="types/ray.js" />
		<file name="base/adapter.js" />
		<file name="interface/notification.js" />
		<file name="interface/factory.js" />
		<file name="interface/dom.js" />
		<file name="interface/elements.js" />
		<file name="interface/attributes.js" />
		<file name="interface/methods.js" />
		<file name="interface/configuration.js" />
		<file name="renderer/canvashandler.js" />
        <file name="renderer/utils.js" />
		<file name="renderer/shadermanager.js" />
		<file name="renderer/bufferhandler.js" />
		<file name="renderer/renderer.js" />
		<file name="renderer/adapter/xml3d.js" />
		<file name="renderer/adapter/transform.js" />
		<file name="renderer/adapter/view.js" />
		<file name="renderer/adapter/shader.js" />
		<file name="renderer/adapter/texture.js" />
		<file name="renderer/adapter/mesh.js" />
		<file name="renderer/adapter/group.js" />
		<file name="renderer/adapter/light.js" />
		<file name="renderer/adapter/data.js" />
		<file name="renderer/adapter/factory.js" />
		<file name="renderer/shaders.js" />
		<file name="renderer/xflow/xflow.js" />
		<file name="../tools/xml3d_scene_controller.js" />
	</filelist>

	<filelist dir="${srcDir}" id="refactored">
			<file name="types/vec3.js" />
			<file name="types/box.js" />
			
		</filelist>
	<!-- =================================
          target: base              
         ================================= -->
	<target name="base" depends="clean" description="description">
		<property name="finalScript" value="${buildDir}/${script.start}${script.ext}.js" />
		<concat destfile="${finalScript}">
			<fileset file="${basedir}/preamble.txt" />
			<filelist refid="sourceFiles"/>
		</concat>
		<replaceregexp file="${finalScript}" match="xml3d.webgl.checkError\(" replace="//xml3d.webgl.checkError\(" byline="true" />
		<replaceregexp file="${finalScript}" match="%VERSION%" replace="${versionStr}" byline="true" />
	</target>

	<target name="physics" depends="clean" description="description">
		<concat destfile="${buildDir}/${physicsScriptName}">
			<fileset file="${basedir}/preamble.txt" />
			<fileset file="${physicsDir}/xml3d_physics.js" />
			<fileset file="${physicsDir}/xml3d_physics_interaction.js" />
		</concat>
		<replaceregexp file="${buildDir}/${physicsScriptName}" match="%VERSION%" replace="${version}" byline="true" />

	</target>

	<target name="clean">
		<delete dir="${buildDir}">
		</delete>
	</target>


</project>
